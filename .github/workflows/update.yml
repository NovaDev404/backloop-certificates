name: Build & Publish Backloop Certs

on:
  schedule:
    - cron: '0 0 */5 * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      - name: Prepare workspace
        run: |
          set -e
          mkdir -p tmp

      - name: Download backloop.dev files from gh-pages
        run: |
          set -e
          curl -fsSL -o tmp/backloop.dev-key.part1.pem https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-key.part1.pem
          curl -fsSL -o tmp/backloop.dev-key.part2.pem https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-key.part2.pem
          curl -fsSL -o tmp/backloop.dev-cert.crt       https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-cert.crt
          curl -fsSL -o tmp/backloop.dev-ca.crt         https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-ca.crt
          curl -fsSL -o tmp/backloop.dev-bundle.crt     https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-bundle.crt

      - name: Build directories & files
        run: |
          set -e

          # List of base filenames
          FILES="backloop.dev-key backloop.dev-cert backloop.dev-ca backloop.dev-bundle backloop.dev-fullchain backloop.dev-all backloop.dev.p12 backloop.dev.pfx backloop.dev-cert.der backloop.dev.cer backloop.dev.jks"

          # Prepare directories for each file
          for f in $FILES; do
            mkdir -p "$f"
          done

          # Combine key parts
          cat tmp/backloop.dev-key.part1.pem tmp/backloop.dev-key.part2.pem > "backloop.dev-key/backloop.dev-key.pem"

          # Copy certificate files into their folders
          cp tmp/backloop.dev-cert.crt "backloop.dev-cert/backloop.dev-cert.crt"
          cp tmp/backloop.dev-ca.crt "backloop.dev-ca/backloop.dev-ca.crt"
          cp tmp/backloop.dev-bundle.crt "backloop.dev-bundle/backloop.dev-bundle.crt"

          # Fullchain: cert + CA
          cat "backloop.dev-cert/backloop.dev-cert.crt" "backloop.dev-ca/backloop.dev-ca.crt" > "backloop.dev-fullchain/backloop.dev-fullchain.pem"

          # All.pem: key + cert + CA
          cat "backloop.dev-key/backloop.dev-key.pem" "backloop.dev-cert/backloop.dev-cert.crt" "backloop.dev-ca/backloop.dev-ca.crt" > "backloop.dev-all/backloop.dev-all.pem"

          # Build P12/PFX
          openssl pkcs12 -export \
            -inkey "backloop.dev-key/backloop.dev-key.pem" \
            -in "backloop.dev-cert/backloop.dev-cert.crt" \
            -certfile "backloop.dev-ca/backloop.dev-ca.crt" \
            -out "backloop.dev.p12/backloop.dev.p12" \
            -passout pass:backloop.dev
          cp "backloop.dev.p12/backloop.dev.p12" "backloop.dev.pfx/backloop.dev.pfx"

          # Build DER/CER
          openssl x509 -in "backloop.dev-cert/backloop.dev-cert.crt" -outform DER -out "backloop.dev-cert.der/backloop.dev-cert.der"
          cp "backloop.dev-cert.der/backloop.dev-cert.der" "backloop.dev.cer/backloop.dev.cer"

          # Build JKS
          keytool -importkeystore \
            -srckeystore "backloop.dev.p12/backloop.dev.p12" \
            -srcstoretype PKCS12 \
            -srcstorepass backloop.dev \
            -destkeystore "backloop.dev.jks/backloop.dev.jks" \
            -deststoretype JKS \
            -deststorepass backloop.dev \
            -noprompt

      - name: Commit & push generated files
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          set -e
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(certs): build & publish all certs in folders"
            git push origin HEAD:main

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: backloop-dev-certs
          path: |
            backloop.dev-key/
            backloop.dev-cert/
            backloop.dev-ca/
            backloop.dev-bundle/
            backloop.dev-fullchain/
            backloop.dev-all/
            backloop.dev.p12/
            backloop.dev.pfx/
            backloop.dev-cert.der/
            backloop.dev.cer/
            backloop.dev.jks/

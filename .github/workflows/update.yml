name: Build & Publish Backloop Certs

on:
  schedule:
    - cron: '0 0 */5 * *' # every 5 days
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      - name: Prepare workspace
        run: |
          set -e
          mkdir -p tmp

      - name: Download backloop.dev files from gh-pages
        run: |
          set -e
          curl -fsSL -o tmp/backloop.dev-key.part1.pem https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-key.part1.pem
          curl -fsSL -o tmp/backloop.dev-key.part2.pem https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-key.part2.pem
          curl -fsSL -o tmp/backloop.dev-cert.crt       https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-cert.crt
          curl -fsSL -o tmp/backloop.dev-ca.crt         https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-ca.crt
          curl -fsSL -o tmp/backloop.dev-bundle.crt     https://raw.githubusercontent.com/perki/backloop.dev/gh-pages/backloop.dev-bundle.crt || true

      - name: Build combined artifacts in tmp and create outputs as split parts
        run: |
          set -e

          # --- setup target dirs (each file will have its own folder) ---
          mkdir -p backloop.dev-key
          mkdir -p backloop.dev-cert
          mkdir -p backloop.dev-ca
          mkdir -p backloop.dev-bundle
          mkdir -p backloop.dev-fullchain
          mkdir -p backloop.dev-all
          mkdir -p backloop.dev.p12
          mkdir -p backloop.dev.pfx
          mkdir -p backloop.dev-cert.der
          mkdir -p backloop.dev.cer
          mkdir -p backloop.dev.jks

          # --- create combined files in tmp (these will NOT be committed) ---
          # combine key parts to a full key for building artifacts
          cat tmp/backloop.dev-key.part1.pem tmp/backloop.dev-key.part2.pem > tmp/backloop.dev-key.pem
          chmod 600 tmp/backloop.dev-key.pem

          # copy cert & ca into tmp (already downloaded)
          cp tmp/backloop.dev-cert.crt tmp/backloop.dev-ca.crt tmp/ 2>/dev/null || true
          cp tmp/backloop.dev-bundle.crt tmp/ 2>/dev/null || true

          # fullchain (cert + CA)
          cat tmp/backloop.dev-cert.crt tmp/backloop.dev-ca.crt > tmp/backloop.dev-fullchain.pem

          # all (key + cert + CA)
          cat tmp/backloop.dev-key.pem tmp/backloop.dev-cert.crt tmp/backloop.dev-ca.crt > tmp/backloop.dev-all.pem

          # Build PKCS#12 (p12) and copy to pfx (temporary in tmp)
          openssl pkcs12 -export -inkey tmp/backloop.dev-key.pem -in tmp/backloop.dev-cert.crt -certfile tmp/backloop.dev-ca.crt -out tmp/backloop.dev.p12 -passout pass:backloop.dev

          # DER and CER from cert
          openssl x509 -in tmp/backloop.dev-cert.crt -outform DER -out tmp/backloop.dev-cert.der

          # JKS: import from PKCS12
          keytool -importkeystore -srckeystore tmp/backloop.dev.p12 -srcstoretype PKCS12 -srcstorepass backloop.dev -destkeystore tmp/backloop.dev.jks -deststoretype JKS -deststorepass backloop.dev -noprompt

          # --- now split each tmp artifact into two parts and move into their tree ---
          # Helper function (bash): split into 2 numeric parts, rename and move
          split_into_two() {
            src="$1"
            destdir="$2"
            basename="$3"
            # use split to create two chunks named tmpchunk1 and tmpchunk2
            split -n 2 --numeric-suffixes=1 --suffix-length=1 "$src" "$src.split."
            # move/rename to desired part filenames
            mv "${src}.split.1" "${destdir}/${basename}.part1"
            mv "${src}.split.2" "${destdir}/${basename}.part2"
          }

          # split the key parts that came from upstream (we already have upstream part files in tmp)
          # Copy upstream parts into target folder with requested names
          cp tmp/backloop.dev-key.part1.pem backloop.dev-key/backloop.dev-key.part1
          cp tmp/backloop.dev-key.part2.pem backloop.dev-key/backloop.dev-key.part2

          # For the other pieces, split the tmp combined artifacts into two halves:
          split_into_two tmp/backloop.dev-cert.crt backloop.dev-cert backloop.dev-cert
          split_into_two tmp/backloop.dev-ca.crt backloop.dev-ca backloop.dev-ca
          # bundle may not exist; only split if present
          if [ -f tmp/backloop.dev-bundle.crt ]; then
            split_into_two tmp/backloop.dev-bundle.crt backloop.dev-bundle backloop.dev-bundle
          fi

          split_into_two tmp/backloop.dev-fullchain.pem backloop.dev-fullchain backloop.dev-fullchain
          split_into_two tmp/backloop.dev-all.pem backloop.dev-all backloop.dev-all
          split_into_two tmp/backloop.dev.p12 backloop.dev.p12 backloop.dev.p12
          # pfx is same as p12 (split the tmp p12 into pfx folder also)
          split_into_two tmp/backloop.dev.p12 backloop.dev.pfx backloop.dev.pfx
          split_into_two tmp/backloop.dev-cert.der backloop.dev-cert.der backloop.dev-cert.der
          split_into_two tmp/backloop.dev-cert.der backloop.dev.cer backloop.dev.cer
          split_into_two tmp/backloop.dev.jks backloop.dev.jks backloop.dev.jks

          # --- secure cleanup: remove tmp combined originals so nothing combined gets committed ---
          rm -f tmp/backloop.dev-key.pem
          rm -f tmp/backloop.dev-fullchain.pem
          rm -f tmp/backloop.dev-all.pem
          rm -f tmp/backloop.dev.p12
          rm -f tmp/backloop.dev-cert.der
          rm -f tmp/backloop.dev.jks
          # leave the original upstream part files in tmp only if you want; remove them to be safe
          rm -f tmp/backloop.dev-key.part1.pem tmp/backloop.dev-key.part2.pem tmp/backloop.dev-cert.crt tmp/backloop.dev-ca.crt tmp/backloop.dev-bundle.crt || true

          # list what we'll commit (for logs)
          echo "====== Files to commit (folders with .part1/.part2) ======"
          ls -la backloop.dev-key || true
          ls -la backloop.dev-cert || true
          ls -la backloop.dev-ca || true
          ls -la backloop.dev-bundle || true
          ls -la backloop.dev-fullchain || true
          ls -la backloop.dev-all || true
          ls -la backloop.dev.p12 || true
          ls -la backloop.dev.pfx || true
          ls -la backloop.dev-cert.der || true
          ls -la backloop.dev.cer || true
          ls -la backloop.dev.jks || true

      - name: Commit & push generated part files
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          set -e
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          # Add only the folders we created (avoid accidentally adding tmp/)
          git add backloop.dev-key backloop.dev-cert backloop.dev-ca backloop.dev-bundle backloop.dev-fullchain backloop.dev-all backloop.dev.p12 backloop.dev.pfx backloop.dev-cert.der backloop.dev.cer backloop.dev.jks || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(certs): build & publish cert files as .part1/.part2 pairs"
            git push origin HEAD:main
          fi

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: backloop-dev-certs-parts
          path: |
            backloop.dev-key/
            backloop.dev-cert/
            backloop.dev-ca/
            backloop.dev-bundle/
            backloop.dev-fullchain/
            backloop.dev-all/
            backloop.dev.p12/
            backloop.dev.pfx/
            backloop.dev-cert.der/
            backloop.dev.cer/
            backloop.dev.jks/
